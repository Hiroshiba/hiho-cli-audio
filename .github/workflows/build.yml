name: Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: "ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ï¼ˆä¾‹: 1.0.0ï¼‰"
        required: true

defaults:
  run:
    shell: bash

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            name: win
          - os: macos-latest
            name: mac
          - os: ubuntu-latest
            name: linux
            container: electronuserland/builder

    runs-on: ${{ matrix.os }}
    container: ${{ matrix.container }}

    steps:
      - name: <Setup> ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: <Setup> pnpmã®è¨­å®š
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: <Setup> Node.jsã¨pnpmã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/setup-node@v4
        with:
          node-version-file: ".node-version"
          cache: "pnpm"

      - name: <Setup> ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      - name: <Setup> package.jsonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
        run: npm version ${{ github.event.inputs.version }} --no-git-tag-version

      - name: <Build> TypeScriptå‹ãƒã‚§ãƒƒã‚¯
        run: pnpm typecheck

      - name: <Build> ESLintã®å®Ÿè¡Œ
        run: pnpm lint

      - name: <Build> Electronã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
        run: pnpm run build

      # è¤‡æ•°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒä¸¦è¡Œã§GitHub Releasesã«åŒæ™‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹ãŸã‚ã€
      # ç«¶åˆã‚„APIåˆ¶é™ã«ã‚ˆã‚Šå¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ã§ä¿¡é ¼æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã€‚
      - name: <Deploy> GitHub Releasesã¸ã®å…¬é–‹ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
        run: |
          max_attempts=3
          for attempt in $(seq 1 $max_attempts); do
            echo "å…¬é–‹è©¦è¡Œ $attempt/$max_attempts"
            if pnpm run publish:${{ matrix.name }}; then
              echo "âœ… å…¬é–‹æˆåŠŸ"
              exit 0
            else
              echo "âŒ å…¬é–‹å¤±æ•— (è©¦è¡Œ $attempt/$max_attempts)"
              if [ $attempt -lt $max_attempts ]; then
                wait_time=$((attempt * 15))
                echo "â³ ${wait_time}ç§’å¾…æ©Ÿã—ã¦ãƒªãƒˆãƒ©ã‚¤..."
                sleep $wait_time
              fi
            fi
          done
          echo "ğŸ’¥ æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸã€‚å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
